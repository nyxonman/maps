<!DOCTYPE html>
<html>
  <head>
    <title>TEPCO GEO LOCATE</title>
    <!-- Meta Data -->
    <meta charset="utf-8">
    <meta name="description" content="Mapping the receiver points">
    <meta name="author" content="Nikesh Man SHAKYA">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <style type="text/css">
        body {
          padding    : 0px;
          margin     : 0px;
          font-family: 'Open Sans', sans-serif;
        }

        .container {
            max-width: 1024px;
            margin: 0 auto;
        }
        
        .reveal{
          display: block;
          width  : 100%;
          height : 400px
        }
        #map {
          width     : 100%;
          height    : 400px;
          margin-top: 15px;
        }
        .hidden{
          display:none;
        }
        .center {
            text-align: center;
        }
        .panel {
          /*position  : relative;*/
          margin    : 0 auto;
          width     : 200px;
          /*height  : 280px;*/
          background: #ffffff;
          padding   : 10px;
          border    : 1px solid #a0a0a0;
        }
        .row {
            color        : #607d8b;
            margin-bottom: 5px;
            width: 100%;
        }
        .col-6{
          width:45%;
          float:left;
          padding-right:5px;
        }
        .button:hover:enabled {
            background-color: #78909c;
            color           : #ffffff;
        }
        .removeTxt:hover {
            color           : #FFFFFF;
            background-color: #A6130E;
        }
        .textBox {
            width : 90%;
            height: 20px;
            border: 1px solid #78909c;
        }
        .textBox:focus{
           outline: none;
            border-color: #9ecaed;
            box-shadow: 0 0 5px #9ecaed;
        }
        .button {
            width           : 199px;
            height          : 25px;
            background-color: #ffffff;
            color           : #78909c;
            border          : 1px solid #78909c;
        }
        #table{
          margin   : 0 auto;
          max-width: 1024px;
        }
        #table table{
          margin-top     : 15px;
          margin-left    : 10px;
          padding        : 15px;
          width          : 98%;
          border-collapse: collapse;
        }
        #table table .tableRow:hover {
            background: #ADD8E6;
        }
        tr:nth-child(even){background-color: #FAEBD7}

        .removeTxt{
          cursor         :pointer;
          text-decoration: underline;
          color          :#A6130E;
        }

        .overlay{
          background   : rgba(75, 116, 156,0.75);
          border       : solid 1px #336699;
          border-radius: 4px;
          box-shadow   : 2px 2px 10px #333;
          padding      : 3px;
          color        : white;
        }


    </style>
    <!-- <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans"> -->
  </head>
  <body>
    <div class="container">

        <div class="panel">
              
              <div class="row center" style="font-size: 20px;">
                Tepco Locate Points
              </div>

              <div class="row">
                <div class="col-6">
                    <label for="rxId"><span style="font-size: 13px;">Rx Id:</span></label>
                    <input type="text" id="rxId" class="textBox" placeholder="RX device id">
                </div>

                <div class="col-6">
                    <label for="txId"><span style="font-size: 13px;">Tx Id:</span></label>
                    <input type="text" id="txId" class="textBox" placeholder="TX device id">
                </div>
                
              </div>
              <div class="row">
                <label for="locationId"><span style="font-size: 13px;">Location:</span></label>
                <input type="text" id="locationId" class="textBox">
              </div>
             
              <div class="row">
                <input type="button" value="Start at your location" id="loc_button" class="button">
              </div>
              <div class="row">
                <input type="button" value="Show in Map" id="showInMap" class="button">
              </div>
              <div class="row">
                <input type="button" value="Export to CSV" id="export2csv" class="button">
              </div>
          
        </div> <!-- panel -->

        <div id="map"></div>

        <div id="table" style="overflow-x: auto" class="center">
          <table border=1>
            <thead>
              <tr><th>U-ID</th><th>Location</th><th>Tx ID</th><th>Rx ID</th><th>StartTime(ms)</th><th>Latitude</th><th>Longitude</th><th>Altitude</th><th>Action</th></tr>
            </thead>
            <tbody id="tableContents">
                
            </tbody>
            <tfoot id="foot">
            </tfoot>
            
          </table>
        </div> <!-- table -->

    </div> <!-- container -->
    


    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    
    <script src="gmaps.min.js"></script>
    
    <!-- <script src="script.js"></script> -->
    <script type="text/javascript">
      
              var sourceIcon      = 's.png', destinationIcon = 'd.png';
              var strokeColor     = '#131540';
              var strokeOpacity   = 0.6;
              var strokeWeight    = 6;
              loc_data            = []
              loc_ids             = []
              u_ids               = [] // txid-rxid-locid
              fields              = ["U_ID", "Loc Id", "Tx Id", "Rx Id", "StartTime", "Latitude", "Longitude", "Altitude", "Action"]
              testTimePerLocation = (45 + (11 * 45) * 2 + 10) * 1000; //(first timeslot + (timeslot * channels) * repetitions  + 10 sec final) *1000 msec
              var timerId         = 0
              var timerRunning    = false;
              

              var mapObj = new GMaps({
                el: '#map',
                lat: 35.689487,
                lng: 139.691706,
                zoom: 11,
              });

              loc_button    = document.getElementById("loc_button");
              showInMap     = document.querySelector('#showInMap')
              tableData     = document.getElementById("tableContents")
              export2csv    = document.querySelector('#export2csv')
              mapDiv        = document.querySelector('#map')
              mapDiv.hidden = true
              document.getElementById("locationId").value = 1

              showInMap.onclick = function(e){
                dismissBtn = document.querySelector('.dismissButton')
                if (dismissBtn){
                  dismissBtn.click()
                }
                console.log(dismissBtn)
                btn = e.target
                if (mapDiv.hidden){
                  mapDiv.hidden=false
                  btn.value = "Hide Map"
                }else{
                 mapDiv.hidden=true;
                  btn.value = "Show in Map"

                }
              }

              export2csv.onclick = function(btn){
                let csvContent = "data:text/csv;charset=utf-8,";
                rxId          = document.getElementById("rxId").value
               
                csvContent     += fields.join(",") + "\r\n"
                loc_data.forEach(function(rowArray) {
                    let row    = rowArray.join(",");
                    csvContent += row + "\r\n";
                });
                var encodedUri = encodeURI(csvContent);
                var link       = document.createElement("a");
                var filename   = `${rxId}_loc_time.csv`
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link); // Required for FF
                link.click();
              };

              function removeItem(tmpLoc){
                // remove in loc_data                      
                var index   = get_index_from_loc_for_loc_data(tmpLoc)
                loc_data.splice(index, 1);
                // remove in loc_ids
                index       = loc_ids.indexOf(tmpLoc)
                loc_ids.splice(index, 1);

                //remove in markers
                // console.log(mapObj.markers)     
                index = get_index_from_loc_for_markers(tmpLoc)
                if (index!=-1){
                  mapObj.removeMarker(mapObj.markers[index])
                }
                //remove the overlays
                index = get_index_from_loc_for_overlays(tmpLoc)
                if (index!=-1){
                  mapObj.removeOverlay(mapObj.overlays[index])
                }
                      
              }
              
              document.addEventListener('click',function(e){
                if(e.target && e.target.className== 'removeTxt'){
                      var rowId   = e.target.parentElement.id
                      var tempArr = rowId.split('-')
                      var tmpLoc  = tempArr[2]
                      if(!tmpLoc) {
                        alert(`Unknown locId ${tmpLoc}`)
                        return
                      }
                      var result = confirm(`Do you confirm to remove LOC ${tmpLoc}`);
                      if (result) {
                        removeItem(tmpLoc)
                        //re-show the table
                        showTable()                         
                      }
                 }
             });

              function showTable(){
                let myHtml = "";
                loc_data.forEach(function(rowArray){
                  myHtml += `<tr class="tableRow" id="${rowArray[0]}">
                                  <td>${rowArray[0]}</td>
                                  <td>${rowArray[1]}</td>
                                  <td>${rowArray[2]}</td>
                                  <td>${rowArray[3]}</td>
                                  <td>${rowArray[4]}</td>
                                  <td>${rowArray[5]}</td>
                                  <td>${rowArray[6]}</td>
                                  <td>${rowArray[7]}</td>
                                  <td class="removeTxt">Remove</td>
                              </tr>`
                    
                });
                tableData.innerHTML = myHtml

              }

              function get_index_from_loc_for_loc_data(locId){
                for (var i = loc_data.length - 1; i >= 0; i--) {
                    if (loc_data[i][1] == locId){
                      return i;
                    }
                }
                return -1;
              }

              function get_index_from_loc_for_markers(locId){
                for (var i = mapObj.markers.length - 1; i >= 0; i--) {
                  let tmpLoc = mapObj.markers[i].title.split("LOC")[1]
                    if (tmpLoc == locId){
                      return i;
                    }
                }
                return -1;
              }

              function get_index_from_loc_for_overlays(locId){
                for (var i = mapObj.overlays.length - 1; i >= 0; i--) {
                  let tmpLoc = mapObj.overlays[i].el.innerText.split("LOC")[1]
                    if (tmpLoc == locId){
                      return i;
                    }
                }
                return -1;
              }

              function testComplete(){
                // audioComplete.play();
                alert("Test Completed. You can now move to new location")
                if (timerId) clearInterval(timerId);

              }
              
              loc_button.onclick = function(e){

                var lat = lon = alt = 0
                locId   = document.getElementById("locationId").value.trim()
                rxId    = document.getElementById("rxId").value.trim()
                txId    = document.getElementById("txId").value.trim()
                uId     = txId + "-" + rxId + "-" + locId // globally unique identification

                /*In case the timer is running and the button is pressed, simply just stop the timer*/
                if(timerRunning){
                  clearInterval(timerId)
                  timerRunning = false
                  loc_button.value = "Start at your location"
                  alert("Current timer Aborted. Test Incomplete. You may have to delete the last entry.")
                  return
                }
                /*Sanity check on empty inputs*/
                if (!locId || !rxId || !txId ){
                  alert("Location, Tx Id and Rx Id cannot be EMPTY.")
                  return false
                }

                /*Sanity check on repeated loc_ids*/
                if(loc_ids.includes(locId)){
                  alert(`location Id '${locId}' already exists`)
                  console.log(`location Id '${locId}' already exists`)
                  return
                }

                GMaps.geolocate({

                      success: function(position) {
                        
                        lat            = position.coords.latitude
                        lon            = position.coords.longitude
                        alt            = position.coords.altitude
                        timestamp      = position.timestamp // is current time in msecs
                        var now        = (new Date().getTime());
                        var expiryTime = now + testTimePerLocation   
                        
                        // create a timer to show the remaining time at the current location and show an alert when time is up
                        timerId = setInterval(function(){ 
                                  now         = (new Date().getTime());
                                  var msecRem = Math.floor((expiryTime - now))
                                  if(msecRem<=0) {
                                    clearInterval(timerId)
                                    timerRunning     = false
                                    loc_button.value = "Start at your location"
                                    alert("Test Completed. You can now move to next location.")
                                    return
                                  }
                                  var minutes = Math.floor((msecRem % (1000 * 60 * 60)) / (1000 * 60));
                                  var seconds = Math.floor((msecRem % (1000 * 60)) / 1000);
                                  loc_button.value = `${minutes} mins ${seconds} secs `
                                  timerRunning = true
                        }, 1000);
                        // setTimeout(testComplete, testTimePerLocation);

                        var m = {
                          'marker' : new Object(),
                          'overlay': new Object()
                        }
                        var overlayContent = `<div class="overlay">RX ${rxId} LOC${locId}</div>`
                        var titleContent   = `RX ${rxId} LOC${locId}`

                        mapObj.setCenter(lat, lon);
                        mapObj.setZoom(16);

                        m.marker = mapObj.addMarker({
                          lat      : lat,
                          lng      : lon,
                          title    : titleContent,
                          details  :'detailed text',
                          draggable: true,
                          
                          dragend: function(event) {
                              var lat = event.latLng.lat();
                              var lon = event.latLng.lng();
                              
                              // remove old overlay location
                              mapObj.removeOverlay(m['overlay'])
                              //draw new overlay
                              m.overlay = mapObj.drawOverlay({
                                            lat           : lat,
                                            lng           : lon,
                                            content       : overlayContent,
                                            verticalOffset: -40
                                          });
                              // m.marker.infoWindow.content = `<h4>DEV ${rxId} LOC ${locId}</h4><div>Paris, France</div><div>${parseFloat(lat).toFixed(3)}, ${parseFloat(lon).toFixed(3)}</div>`
                              // m.marker.infoWindow="dragged finished"

                              //update log_data
                              var tmpLoc         = (m.marker.infoWindow.content).split(" ")[3]
                              var index          = get_index_from_loc_for_loc_data(tmpLoc)
                              loc_data[index][5] = lat
                              loc_data[index][6] = lon

                              // update the table
                              showTable()

                          },
                          icon      : sourceIcon,
                          infoWindow: {
                                        content : `<h4>Rx ${rxId} LOC ${locId} </h4><div>Paris, France</div><div>${parseFloat(lat).toFixed(4)}, ${parseFloat(lon).toFixed(4)}</div>`,
                                        maxWidth: 120
                                      },
                          dblclick: function(e){
                            var tmpLoc = (m.marker.infoWindow.content).split(" ")[3]
                            var result = confirm(`Do you confirm to remove LOC ${tmpLoc}`);
                            if (!result) {
                                return;
                            }
                            mapObj.removeMarker(m.marker)
                            mapObj.removeOverlay(m.overlay)
                            var index   = get_index_from_loc_for_loc_data(tmpLoc)
                            loc_data.splice(index, 1);
                            // remove in loc_ids
                            index       = loc_ids.indexOf(tmpLoc)
                            loc_ids.splice(index, 1);
                            showTable();

                          }

                        });

                        m.overlay = mapObj.drawOverlay({
                                      lat           : lat,
                                      lng           : lon,
                                      content       : overlayContent,
                                      verticalOffset: -40
                                    });

                        // push data to array
                        loc_data.push([uId, locId, txId, rxId, timestamp, lat, lon, alt])
                        loc_ids.push(locId)

                        showTable()

                        //update the location id to new non existing value
                        do{
                          locId++
                          console.log(locId.toString(), loc_ids, loc_ids.includes(locId.toString())? "exists" : "not exists")

                        }while(loc_ids.includes(locId.toString()))
                        document.getElementById("locationId").value = locId
                      },

                      error: function(error) {
                        alert(`Error Code ${error.code} : ${error.message}`);
                      },

                      not_supported: function() {
                        alert("Your browser does not support geolocation");
                      },

                      options: {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                      }
                });

              };


    </script>
  </body>
</html>

<!-- https://github.com/sitepoint-editors/mapit -->